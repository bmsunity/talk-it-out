<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Talk It Out - Web Game</title>
    

  </head>
    
  <body>
  <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Talk It Out üéôÔ∏è ‚Äî Speaking & Listening Game</title>

<!-- MP3 encoder + ZIP export libs -->
<script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
  :root{
    --bg:#0b1020; --bg2:#141a2b; --card:#1a2342; --ink:#e9ecff; --ink-dim:#aeb7e6;
    --accent:#7bd3ff; --accent-2:#a8ffbf; --warn:#ffcc7b; --danger:#ff8aa8;
    --ok:#86f0a7; --muted:#2a3257;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--ink)}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;color:#0a0a0a;font-weight:900}
  h1{margin:0;font-size:22px}
  .pod{background:linear-gradient(180deg,#0f152e,#0d1837);border:1px solid #232b4f;border-radius:18px;padding:18px;display:flex;gap:16px;align-items:center;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .knob{width:14px;height:14px;border-radius:50%;background:var(--accent);box-shadow:0 0 12px var(--accent)}
  .directions{margin:12px 0 18px;color:var(--ink-dim);line-height:1.5}
  .grid{display:grid;grid-template-columns:1.2fr .8fr; gap:16px}
  .card{background:linear-gradient(180deg, #121a36, #121a30); border:1px solid #242d54;border-radius:16px;padding:16px}
  .card h2{margin:0 0 10px 0;font-size:18px}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0}
  input, select, textarea{background:#0f1430;color:var(--ink);border:1px solid #2a3463;border-radius:12px;padding:10px 12px;font:inherit}
  input[type="number"]{width:110px}
  textarea{min-height:90px;resize:vertical}
  .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#67cfff,#4ab3ff);color:#05111a}
  .btn.alt{background:#263062;color:var(--ink)}
  .btn.warn{background:linear-gradient(180deg,#ffd27c,#ffad4a); color:#101010}
  .btn.ok{background:linear-gradient(180deg,#a0ffbf,#62f19a); color:#0e1510}
  .btn.danger{background:linear-gradient(180deg,#ff9db5,#ff6f93); color:#16080d}
  .pill{background:#1e2750;border:1px solid #2c3560;color:var(--ink-dim);padding:6px 10px;border-radius:999px}
  .prompt{font-size:18px;background:#0e1736;border:1px dashed #33407a;border-radius:14px;padding:12px;margin:8px 0}
  .timer{font-variant-numeric:tabular-nums;font-weight:700}
  audio{width:100%; margin-top:8px}
  .rubric-btns{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .rubric-chip{padding:6px 10px;border-radius:999px;background:#10183d;border:1px solid #2a3563;font-weight:700}
  .rubric-modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
  .rubric{background:#0f1530;border:1px solid #2b3563;border-radius:16px;max-width:700px;width:100%;padding:16px;outline:0}
  table{width:100%;border-collapse:collapse}
  th, td{border-bottom:1px solid #2b3563;padding:10px;text-align:left}
  th{color:var(--ink-dim);font-weight:600}
  .score{font-weight:800}
  .list{max-height:300px;overflow:auto;border:1px solid #232b4f;border-radius:12px}
  .record{display:grid;grid-template-columns:160px 1fr 180px 140px;gap:10px;align-items:center;padding:10px;border-bottom:1px solid #232b4f}
  .record:last-child{border-bottom:0}
  .tag{font-size:12px}
  .badge{padding:4px 8px;border-radius:999px;background:#1e2750;border:1px solid #2c3560}
  .muted{color:var(--ink-dim)}
  .foot{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
  .hidden{display:none !important}
  .small{font-size:12px;color:var(--ink-dim)}
  .weight{display:flex;gap:8px;align-items:center}
  .weight input[type="number"]{width:80px}
</style>
</head>
<body>
  <div class="wrap">
    <header class="pod">
      <div class="brand">
        <div class="logo">üéôÔ∏è</div>
        <div>
          <h1>Talk It Out ‚Äî Web Game</h1>
          <div class="small">Podcast-style UI ‚Ä¢ MP3 + CSV export ‚Ä¢ Rubrics for Speaker & Listener</div>
        </div>
      </div>
      <div class="pill"><span class="knob"></span> Live</div>
    </header>

    <div class="directions">
      <strong>Directions:</strong> 1) Enter <em>Speaker</em> and <em>Listener</em> (first name + last initial) and a <em>Team letter</em>.  
      2) <b>New Prompt</b> ‚Üí Speaker <b>Record (30s)</b>. 3) Listener <b>Listen</b> and write or record a summary.  
      4) Open both <b>Rubrics</b> and click <b>Apply</b> (scores update visibly). 5) Adjust weights if needed; Teacher points auto-fill.  
      6) <b>Save Round</b> ‚Üí <b>Export ZIP</b> for all MP3s + CSV with listener‚Äôs text inline.
    </div>

    <div class="grid">
      <!-- LEFT: Game area -->
      <section class="card">
        <h2>Round Controls</h2>

        <div class="row">
          <input id="speakerName" placeholder="Speaker Name (e.g., Jordan K.)" />
          <input id="listenerName" placeholder="Listener Name (e.g., Skylar M.)" />
          <select id="teamLetter" title="Team">
            <option value="">Team Letter</option>
            <option>A</option><option>B</option><option>C</option><option>D</option><option>E</option>
          </select>
          <button class="btn alt" id="newPromptBtn">üé≤ New Prompt</button>
          <span class="pill">Round <span id="roundNum">1</span></span>
        </div>

        <div class="prompt" id="promptText">Click ‚ÄúNew Prompt‚Äù to begin.</div>

        <div class="row">
          <button class="btn primary" id="recordBtn">üé§ Record Speaker (30s)</button>
          <span class="timer" id="timer">00:30</span>
          <button class="btn alt" id="stopBtn" disabled>‚èπ Stop</button>
          <button class="btn alt" id="playBtn" disabled>‚ñ∂Ô∏è Play Speaker</button>
        </div>
        <audio id="speakerAudio" controls class="hidden"></audio>

        <div class="row">
          <textarea id="listenerSummary" placeholder="Listener: type your summary here (or record below)‚Ä¶"></textarea>
        </div>

        <div class="row">
          <button class="btn alt" id="recordListenerBtn">üéôÔ∏è Record Listener</button>
          <button class="btn alt" id="stopListenerBtn" disabled>‚èπ Stop</button>
          <button class="btn alt" id="playListenerBtn" disabled>‚ñ∂Ô∏è Play Listener</button>
        </div>
        <audio id="listenerAudio" controls class="hidden"></audio>

        <div class="row rubric-btns">
          <button class="btn warn" id="speakerRubricBtn" type="button">üßÆ Speaker Rubric</button>
          <span class="rubric-chip" id="speakerScoreDisp">Speaker Score: 0</span>
          <button class="btn warn" id="listenerRubricBtn" type="button">üßÆ Listener Rubric</button>
          <span class="rubric-chip" id="listenerScoreDisp">Listener Score: 0</span>
        </div>

        <div class="row rubric-btns">
          <div class="weight">
            <label class="small">Speaker wt.</label>
            <input id="weightSpeaker" type="number" step="0.1" value="1.0" />
          </div>
          <div class="weight">
            <label class="small">Listener wt.</label>
            <input id="weightListener" type="number" step="0.1" value="1.0" />
          </div>
          <input id="teacherPoints" type="number" min="0" step="1" placeholder="Teacher Points (auto)" />
          <label class="pill"><input id="teacherApproved" type="checkbox" /> Teacher Approved</label>
        </div>

        <div class="foot">
          <button class="btn ok" id="saveRoundBtn">üíæ Save Round</button>
          <button class="btn danger" id="resetBtn">‚ôªÔ∏è Reset</button>
        </div>
      </section>

      <!-- RIGHT: Saved list + export -->
      <aside class="card">
        <h2>Saved Rounds</h2>
        <div class="row">
          <button class="btn alt" id="loadSavedBtn">‚§¥Ô∏è Load Saved</button>
          <button class="btn ok" id="exportZipBtn">üì¶ Export ZIP (MP3 + CSV)</button>
          <span class="small">Autosaves locally.</span>
        </div>
        <div class="list" id="recordsList"></div>
      </aside>
    </div>
  </div>

  <!-- Rubric modal -->
  <div class="rubric-modal" id="rubricModal" aria-hidden="true">
    <div class="rubric" role="dialog" aria-modal="true" aria-labelledby="rubricTitle">
      <h3 id="rubricTitle">Rubric</h3>
      <table id="rubricTable">
        <thead><tr><th>Criteria</th><th class="muted">1</th><th class="muted">2</th><th class="muted">3</th><th class="muted">4</th><th>Score</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="row" style="justify-content:space-between">
        <div>Total: <span class="score" id="rubricTotal">0</span></div>
        <div class="rubric-btns">
          <button class="btn alt" id="rubricCancel" type="button">Close</button>
          <button class="btn primary" id="rubricApply" type="button">Apply</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===========================================================
   TALK IT OUT ‚Äî MAIN SCRIPT (Rubric open fix + auto teacher points)
   =========================================================== */

// ---------- Config ----------
const PROMPTS = [
  "Describe the weirdest invention you can imagine.",
  "Teach us your favorite life hack in 30 seconds.",
  "Explain a game you love to someone who has never played it.",
  "Convince us that breakfast is (or isn‚Äôt) the best meal.",
  "Tell a true mini-story that made you laugh recently.",
  "Explain how to do something in five steps.",
  "Describe a place you‚Äôd love to visit and why.",
  "Pitch a helpful app idea for students.",
  "If you could interview any person, who and why?",
  "Explain a science fact in your own words."
];

// ---------- State ----------
let roundIndex = 1;
let currentPrompt = "";
let records = [];

const els = {
  // basics
  promptText: document.getElementById('promptText'),
  roundNum: document.getElementById('roundNum'),
  newPromptBtn: document.getElementById('newPromptBtn'),

  // names/team
  speakerName: document.getElementById('speakerName'),
  listenerName: document.getElementById('listenerName'),
  teamLetter: document.getElementById('teamLetter'),

  // speaker audio
  recordBtn: document.getElementById('recordBtn'),
  stopBtn: document.getElementById('stopBtn'),
  playBtn: document.getElementById('playBtn'),
  timer: document.getElementById('timer'),
  speakerAudio: document.getElementById('speakerAudio'),

  // listener
  listenerSummary: document.getElementById('listenerSummary'),
  recordListenerBtn: document.getElementById('recordListenerBtn'),
  stopListenerBtn: document.getElementById('stopListenerBtn'),
  playListenerBtn: document.getElementById('playListenerBtn'),
  listenerAudio: document.getElementById('listenerAudio'),

  // rubrics
  speakerRubricBtn: document.getElementById('speakerRubricBtn'),
  listenerRubricBtn: document.getElementById('listenerRubricBtn'),
  speakerScoreDisp: document.getElementById('speakerScoreDisp'),
  listenerScoreDisp: document.getElementById('listenerScoreDisp'),

  // weights + teacher points
  weightSpeaker: document.getElementById('weightSpeaker'),
  weightListener: document.getElementById('weightListener'),
  teacherPoints: document.getElementById('teacherPoints'),
  teacherApproved: document.getElementById('teacherApproved'),

  // save/export
  saveRoundBtn: document.getElementById('saveRoundBtn'),
  resetBtn: document.getElementById('resetBtn'),
  recordsList: document.getElementById('recordsList'),
  loadSavedBtn: document.getElementById('loadSavedBtn'),
  exportZipBtn: document.getElementById('exportZipBtn'),

  // rubric modal
  rubricModal: document.getElementById('rubricModal'),
  rubricTitle: document.getElementById('rubricTitle'),
  rubricTableBody: document.querySelector('#rubricTable tbody'),
  rubricTotal: document.getElementById('rubricTotal'),
  rubricApply: document.getElementById('rubricApply'),
  rubricCancel: document.getElementById('rubricCancel')
};

const LS_KEY = "talkItOut.records.v3"; // bump for schema changes

// rubric schemas
const SPEAKER_RUBRIC = [
  { key:"clarity", label:"Clarity & Organization" },
  { key:"content", label:"Relevant Content" },
  { key:"delivery", label:"Delivery (pace, tone, volume)" },
  { key:"time", label:"Stayed near 30s target" }
];
const LISTENER_RUBRIC = [
  { key:"accuracy", label:"Accurate Summary" },
  { key:"completeness", label:"Complete & Concise" },
  { key:"language", label:"Clear Writing / Speech" }
];

let speakerRubricScores = {}; // { key:1..4 }
let listenerRubricScores = {};
let activeRubric = null; // { role:'speaker'|'listener', scores:{} }
let speakerCountdown = null, secondsLeft = 30;

// ---------- Utils ----------
const safe = s => String(s).replace(/[^\w\-]+/g,'_');
const nowStamp = () => new Date().toISOString().replace('T',' ').split('.')[0];
const fmtSec = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(Math.floor(s%60)).padStart(2,'0')}`;
const sumRubric = (obj={}) => Object.values(obj).reduce((a,c)=>a+(parseInt(c)||0),0);
const csvRow = arr => arr.map(v=>v==null?"":(/[",\n]/.test(String(v))?`"${String(v).replace(/"/g,'""')}"`:String(v))).join(",");

// ---------- Modal helpers (robust) ----------
function showModal(){
  els.rubricModal.style.display = 'flex';
  els.rubricModal.setAttribute('aria-hidden','false');
  // focus first radio or Apply
  const firstRadio = els.rubricModal.querySelector('input[type="radio"]') || els.rubricApply;
  firstRadio.focus();
}
function hideModal(){
  els.rubricModal.style.display = 'none';
  els.rubricModal.setAttribute('aria-hidden','true');
}
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && els.rubricModal.style.display === 'flex'){
    hideModal();
  }
});

// ---------- Rubric open (FIXED) ----------
function openRubric(role, existingScores={}){
  try{
    activeRubric = { role, scores:{...existingScores} };
    els.rubricTitle.textContent = role==='speaker' ? 'Speaker Rubric' : 'Listener Rubric';
    const spec = role==='speaker' ? SPEAKER_RUBRIC : LISTENER_RUBRIC;

    els.rubricTableBody.innerHTML = "";
    spec.forEach(row=>{
      const tr = document.createElement('tr');
      const current = activeRubric.scores[row.key] ?? 0;
      tr.innerHTML = `
        <td>${row.label}</td>
        <td><label><input type="radio" name="rb_${row.key}" value="1" ${current===1?'checked':''}/> 1</label></td>
        <td><label><input type="radio" name="rb_${row.key}" value="2" ${current===2?'checked':''}/> 2</label></td>
        <td><label><input type="radio" name="rb_${row.key}" value="3" ${current===3?'checked':''}/> 3</label></td>
        <td><label><input type="radio" name="rb_${row.key}" value="4" ${current===4?'checked':''}/> 4</label></td>
        <td id="disp_${row.key}" class="score">${current}</td>
      `;
      els.rubricTableBody.appendChild(tr);
    });

    // hook radio changes
    els.rubricTableBody.querySelectorAll('input[type="radio"]').forEach(inp=>{
      inp.addEventListener('change', ()=>{
        const key = inp.name.replace('rb_','');
        activeRubric.scores[key] = parseInt(inp.value,10);
        const cell = document.getElementById(`disp_${key}`);
        if(cell) cell.textContent = activeRubric.scores[key];
        recalcRubricTotal();
      });
    });

    recalcRubricTotal();
    showModal();
  }catch(err){
    console.error('Rubric open failed', err);
    alert('Could not open rubric. Try again or reload the page.');
  }
}

function recalcRubricTotal(){
  const total = sumRubric(activeRubric?.scores||{});
  els.rubricTotal.textContent = total;
}

// Close / Apply
els.rubricCancel.addEventListener('click', hideModal);
els.rubricApply.addEventListener('click', ()=>{
  if(!activeRubric){ hideModal(); return; }
  if(activeRubric.role==='speaker'){
    speakerRubricScores = {...activeRubric.scores};
    const total = sumRubric(speakerRubricScores);
    els.speakerScoreDisp.textContent = `Speaker Score: ${total}`;
  }else{
    listenerRubricScores = {...activeRubric.scores};
    const total = sumRubric(listenerRubricScores);
    els.listenerScoreDisp.textContent = `Listener Score: ${total}`;
  }
  // auto-fill teacher points after any rubric apply
  autoFillTeacherPoints();
  hideModal();
});

// Bind buttons (explicit & reliable)
els.speakerRubricBtn.addEventListener('click', ()=>openRubric('speaker', speakerRubricScores));
els.listenerRubricBtn.addEventListener('click', ()=>openRubric('listener', listenerRubricScores));

// ---------- Auto-fill Teacher Points ----------
function autoFillTeacherPoints(){
  const s = sumRubric(speakerRubricScores);
  const l = sumRubric(listenerRubricScores);
  const ws = parseFloat(els.weightSpeaker.value || '1');
  const wl = parseFloat(els.weightListener.value || '1');
  if(Number.isFinite(ws) && Number.isFinite(wl)){
    const total = Math.round(s*ws + l*wl);
    els.teacherPoints.value = total;
  }
}
// update on weight changes too
['change','input'].forEach(ev=>{
  els.weightSpeaker.addEventListener(ev, autoFillTeacherPoints);
  els.weightListener.addEventListener(ev, autoFillTeacherPoints);
});

// ---------- Prompt ----------
els.newPromptBtn.addEventListener('click', ()=>{
  currentPrompt = PROMPTS[Math.floor(Math.random()*PROMPTS.length)];
  els.promptText.textContent = currentPrompt;
});

// ---------- Recorder(s) ----------
class Mp3Recorder {
  constructor(){ this.context=null; this.stream=null; this.processor=null; this.samples=[]; this.sampleRate=44100; this.isRecording=false; }
  async start(){
    if(this.isRecording) return;
    this.stream = await navigator.mediaDevices.getUserMedia({audio:true});
    this.context = new (window.AudioContext || window.webkitAudioContext)({sampleRate:this.sampleRate});
    const src = this.context.createMediaStreamSource(this.stream);
    this.processor = this.context.createScriptProcessor(2048,1,1);
    src.connect(this.processor); this.processor.connect(this.context.destination);
    this.samples=[]; this.isRecording=true;
    this.processor.onaudioprocess = e => { if(!this.isRecording) return; this.samples.push(new Float32Array(e.inputBuffer.getChannelData(0))); };
  }
  async stop(){
    if(!this.isRecording) return { mp3Url:null, wavUrl:null };
    this.isRecording=false;
    try{ this.processor.disconnect(); }catch{}
    try{ this.context.close(); }catch{}
    try{ this.stream.getTracks().forEach(t=>t.stop()); }catch{}
    const merged = this._merge(this.samples);
    const wavBlob = this._wav(merged, this.sampleRate);
    let mp3Blob=null;
    try{ if(typeof lamejs!=='undefined'){ mp3Blob=this._mp3(merged,this.sampleRate); } }catch(e){ console.warn('mp3 encode failed',e); }
    const mp3Url = mp3Blob ? URL.createObjectURL(mp3Blob) : null;
    const wavUrl = URL.createObjectURL(wavBlob);
    return { mp3Blob, mp3Url, wavBlob, wavUrl };
  }
  _merge(chunks){ const len=chunks.reduce((a,c)=>a+c.length,0); const out=new Float32Array(len); let off=0; for(const c of chunks){ out.set(c,off); off+=c.length; } return out; }
  _f32to16(f){ const out=new Int16Array(f.length); for(let i=0;i<f.length;i++){ let s=Math.max(-1,Math.min(1,f[i])); out[i]= s<0 ? s*0x8000 : s*0x7FFF; } return out; }
  _wav(samples,rate){
    const pcm=this._f32to16(samples); const buf=new ArrayBuffer(44+pcm.length*2); const v=new DataView(buf);
    const w=(off,str)=>{ for(let i=0;i<str.length;i++) v.setUint8(off+i,str.charCodeAt(i)); };
    w(0,'RIFF'); v.setUint32(4,36+pcm.length*2,true); w(8,'WAVE'); w(12,'fmt '); v.setUint32(16,16,true);
    v.setUint16(20,1,true); v.setUint16(22,1,true); v.setUint32(24,rate,true); v.setUint32(28,rate*2,true);
    v.setUint16(32,2,true); v.setUint16(34,16,true); w(36,'data'); v.setUint32(40,pcm.length*2,true);
    let o=44; for(let i=0;i<pcm.length;i++,o+=2){ v.setInt16(o,pcm[i],true); }
    return new Blob([v],{type:'audio/wav'});
  }
  _mp3(samples,rate){
    const enc=new lamejs.Mp3Encoder(1,rate,128); const pcm=this._f32to16(samples); const chunk=1152; const out=[];
    for(let i=0;i<pcm.length;i+=chunk){ const buf=enc.encodeBuffer(pcm.subarray(i,i+chunk)); if(buf.length) out.push(buf); }
    const end=enc.flush(); if(end.length) out.push(end); return new Blob(out,{type:'audio/mpeg'});
  }
}
const speakerRec = new Mp3Recorder();
const listenerRec = new Mp3Recorder();

els.recordBtn.addEventListener('click', async ()=>{
  try{
    secondsLeft=30; els.timer.textContent=fmtSec(secondsLeft);
    els.stopBtn.disabled=false; els.recordBtn.disabled=true;
    await speakerRec.start();
    speakerCountdown=setInterval(()=>{
      secondsLeft--; els.timer.textContent=fmtSec(secondsLeft);
      if(secondsLeft<=0) els.stopBtn.click();
    },1000);
  }catch(e){
    alert("Microphone permission is required.\nTip: click the lock icon in the address bar and allow the Microphone.");
    els.recordBtn.disabled=false; els.stopBtn.disabled=true;
  }
});
els.stopBtn.addEventListener('click', async ()=>{
  try{
    clearInterval(speakerCountdown);
    els.stopBtn.disabled=true;
    const { mp3Url, wavUrl } = await speakerRec.stop();
    const url = mp3Url || wavUrl;
    els.speakerAudio.src = url; els.speakerAudio.classList.remove('hidden');
    els.playBtn.disabled = !url; els.recordBtn.disabled=false;
    els.timer.textContent="00:30";
  }catch(e){
    console.warn(e); alert("Recording stop failed. Try again.");
    els.recordBtn.disabled=false; els.stopBtn.disabled=true;
  }
});
els.playBtn.addEventListener('click', ()=>{ if(els.speakerAudio.src) els.speakerAudio.play().catch(()=>{}); });

els.recordListenerBtn.addEventListener('click', async ()=>{
  try{ els.stopListenerBtn.disabled=false; els.recordListenerBtn.disabled=true; await listenerRec.start(); }
  catch(e){ alert("Microphone permission is required for listener recording."); els.recordListenerBtn.disabled=false; els.stopListenerBtn.disabled=true; }
});
els.stopListenerBtn.addEventListener('click', async ()=>{
  try{
    els.stopListenerBtn.disabled=true;
    const { mp3Url, wavUrl } = await listenerRec.stop();
    const url = mp3Url || wavUrl;
    els.listenerAudio.src = url; els.listenerAudio.classList.remove('hidden');
    els.playListenerBtn.disabled = !url; els.recordListenerBtn.disabled=false;
  }catch(e){ console.warn(e); alert("Listener recording stop failed. Try again."); els.recordListenerBtn.disabled=false; els.stopListenerBtn.disabled=true; }
});
els.playListenerBtn.addEventListener('click', ()=>{ if(els.listenerAudio.src) els.listenerAudio.play().catch(()=>{}); });

// ---------- Save / Reset / List ----------
function updateList(){
  els.recordsList.innerHTML="";
  if(records.length===0){
    els.recordsList.innerHTML = `<div class="muted" style="padding:12px">No rounds saved yet.</div>`;
    return;
  }
  records.forEach(r=>{
    const div=document.createElement('div'); div.className='record';
    const tag=r.teacherApproved? `<span class="badge">Approved</span>`: `<span class="badge" style="opacity:.65">Pending</span>`;
    div.innerHTML=`
      <div>
        <div class="tag">Round ${r.round}</div>
        <div class="small muted">${r.ts}</div>
      </div>
      <div>
        <div><strong>Speaker:</strong> ${r.speakerName} ‚Ä¢ <strong>Listener:</strong> ${r.listenerName} ‚Ä¢ Team ${r.team}</div>
        <div class="small muted">${r.prompt}</div>
        <div class="small">Scores ‚Äî Speaker: <b>${r.speakerScoreTotal||0}</b> ‚Ä¢ Listener: <b>${r.listenerScoreTotal||0}</b></div>
      </div>
      <div>
        <button class="btn alt" data-play="${r.id}S">‚ñ∂Ô∏è Speaker</button>
        <button class="btn alt" data-play="${r.id}L">‚ñ∂Ô∏è Listener</button>
      </div>
      <div>
        <div>${tag}</div>
        <div class="small">Pts: ${r.teacherPoints ?? 0}</div>
      </div>
    `;
    els.recordsList.appendChild(div);
    div.querySelector(`[data-play="${r.id}S"]`).onclick=()=>{ const a=new Audio(r.speakerSrc); a.play().catch(()=>{}); };
    div.querySelector(`[data-play="${r.id}L"]`).onclick=()=>{ if(r.listenerSrc){ const a=new Audio(r.listenerSrc); a.play().catch(()=>{}); } else { alert("No listener audio for this round."); } };
  });
}
function saveToLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(records)); }
function loadFromLocal(){ try{ const raw=localStorage.getItem(LS_KEY); if(raw){ records=JSON.parse(raw); } }catch(e){ console.warn(e); } updateList(); }

els.saveRoundBtn.addEventListener('click', ()=>{
  const speakerName=els.speakerName.value.trim();
  const listenerName=els.listenerName.value.trim();
  const team=els.teamLetter.value;
  if(!speakerName || !listenerName || !team){ alert("Enter Speaker name, Listener name, and Team letter."); return; }
  if(!currentPrompt){ alert("Click New Prompt to get a prompt."); return; }

  const rec={
    id:crypto.randomUUID(),
    round:roundIndex,
    ts:nowStamp(),
    team,
    speakerName,
    listenerName,
    prompt:currentPrompt,
    speakerSrc:els.speakerAudio.src || "",
    listenerSrc:els.listenerAudio.src || "",
    listenerText:els.listenerSummary.value.trim(),
    speakerRubric:{...speakerRubricScores},
    listenerRubric:{...listenerRubricScores},
    speakerScoreTotal:sumRubric(speakerRubricScores),
    listenerScoreTotal:sumRubric(listenerRubricScores),
    teacherPoints:parseInt(els.teacherPoints.value||"0",10),
    teacherApproved:!!els.teacherApproved.checked
  };
  records.push(rec); saveToLocal(); updateList();

  // next round prep
  roundIndex++; els.roundNum.textContent=roundIndex;
  els.listenerSummary.value=""; els.teacherApproved.checked=false;
  speakerRubricScores={}; listenerRubricScores={};
  els.speakerScoreDisp.textContent="Speaker Score: 0";
  els.listenerScoreDisp.textContent="Listener Score: 0";
  els.teacherPoints.value="";
  els.speakerAudio.src=""; els.listenerAudio.src="";
  els.speakerAudio.classList.add('hidden'); els.listenerAudio.classList.add('hidden');
  els.playBtn.disabled=true; els.playListenerBtn.disabled=true;
  alert("Round saved!");
});

els.resetBtn.addEventListener('click', ()=>{
  if(confirm("Reset current fields (does not delete saved rounds)?")){
    els.speakerName.value=""; els.listenerName.value=""; els.teamLetter.value="";
    currentPrompt=""; els.promptText.textContent="Click ‚ÄúNew Prompt‚Äù to begin.";
    els.listenerSummary.value=""; els.teacherApproved.checked=false;
    speakerRubricScores={}; listenerRubricScores={};
    els.speakerScoreDisp.textContent="Speaker Score: 0";
    els.listenerScoreDisp.textContent="Listener Score: 0";
    els.teacherPoints.value="";
    els.speakerAudio.src=""; els.listenerAudio.src="";
    els.speakerAudio.classList.add('hidden'); els.listenerAudio.classList.add('hidden');
    els.playBtn.disabled=true; els.playListenerBtn.disabled=true;
  }
});

els.loadSavedBtn.addEventListener('click', ()=>{ loadFromLocal(); alert("Loaded saved rounds from this browser."); });

// ---------- Export ZIP + CSV ----------
els.exportZipBtn.addEventListener('click', async ()=>{
  if(records.length===0){ alert("No rounds to export."); return; }
  const zip=new JSZip(); const folder=zip.folder("talk-it-out")||zip;

  const header=["timestamp","round","team","speaker_name","listener_name","prompt",
    "speaker_score_total","listener_score_total","speaker_rubric_json","listener_rubric_json",
    "teacher_points","teacher_approved","speaker_mp3","listener_mp3","listener_text"];
  const rows=[header.join(",")];

  async function blobFromUrl(url){ if(!url) return null; try{ const r=await fetch(url); return await r.blob(); }catch{return null;} }

  for(const r of records){
    // speaker
    const spBlob=await blobFromUrl(r.speakerSrc); let spFile="";
    if(spBlob){ const ext=spBlob.type==='audio/mpeg'?'mp3':'wav'; spFile=`round${r.round}_${safe(r.team)}_${safe(r.speakerName)}_SPEAKER.${ext}`; folder.file(spFile, spBlob); }
    // listener
    const lsBlob=await blobFromUrl(r.listenerSrc); let lsFile="";
    if(lsBlob){ const ext=lsBlob.type==='audio/mpeg'?'mp3':'wav'; lsFile=`round${r.round}_${safe(r.team)}_${safe(r.listenerName)}_LISTENER.${ext}`; folder.file(lsFile, lsBlob); }

    rows.push(csvRow([
      r.ts, r.round, r.team, r.speakerName, r.listenerName, r.prompt,
      r.speakerScoreTotal||0, r.listenerScoreTotal||0,
      JSON.stringify(r.speakerRubric||{}), JSON.stringify(r.listenerRubric||{}),
      r.teacherPoints||0, r.teacherApproved?1:0,
      spFile, lsFile, r.listenerText||""
    ]));
  }
  const csvContent=rows.join("\n"); folder.file("talk-it-out-grades.csv", csvContent);
  const blob=await zip.generateAsync({type:"blob"}); saveAs(blob, `talk-it-out_${new Date().toISOString().slice(0,10)}.zip`);
});

// ---------- Init ----------
function loadFromLocal(){ try{ const raw=localStorage.getItem(LS_KEY); if(raw){ records=JSON.parse(raw); } }catch(e){ console.warn(e); } updateList(); }
loadFromLocal();
if(records.length>0){ roundIndex = Math.max(...records.map(r=>r.round))+1; els.roundNum.textContent=roundIndex; }

// Accessibility: space toggles speaker record/stop
document.addEventListener('keydown', (e)=>{
  if(e.key===' ' && !e.repeat && document.activeElement===document.body){
    if(!els.stopBtn.disabled) els.stopBtn.click();
    else if(!els.recordBtn.disabled) els.recordBtn.click();
  }
});
</script>
</body>
</html>
    
  </body>
  
</html>
